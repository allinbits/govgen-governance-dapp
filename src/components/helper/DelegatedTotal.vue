<script setup lang="ts">
import apolloClient from "@/apolloClient";
import { bus } from "@/bus";
import { useChainData } from "@/composables/useChainData";
import { totalAmounts } from "@/utility";
import { Coin } from "@cosmjs/proto-signing";
import { provideApolloClient } from "@vue/apollo-composable";
import { ref, watch } from "vue";
const { timestamp, address } = defineProps<{ timestamp: string; address: string }>();
const { getDelegatedAsync, getBlockHeight } = useChainData();

const height = getBlockHeight(timestamp);
const delegated = ref<Coin[] | null>(null);
watch(height, async (newHeight, oldHeight) => {
  if (newHeight && newHeight.blocks[0].height != oldHeight?.blocks[0].height) {
    provideApolloClient(apolloClient);
    try {
      const dq = await getDelegatedAsync(address, newHeight.blocks[0].height);
      if (dq) {
        delegated.value = dq.staked_balances.map((x) => {
          return x.amount;
        });
      } else {
        delegated.value = [];
      }
    } catch (e) {
      bus.emit("error", e);
    }
  }
});
</script>
<template>
  <span>{{ totalAmounts(delegated ?? []) }}</span>
</template>
